<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time Tracker Enhanced</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f7fa;
      color: #333;
      padding: 20px;
    }
    h1, h2 {
      color: #2c3e50;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .box {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    button {
      margin: 5px 5px 5px 0;
      padding: 8px 12px;
      font-size: 14px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #2980b9;
    }
    input, select {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border-bottom: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .project-buttons {
      margin-top: 8px;
    }
    .manual-input {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }
    .manual-input input {
      width: 60px;
    }
  </style>
</head>
<body>

  <h1>Daily Time Tracker</h1>

  <div class="container">
    <div class="box">
      <h2>Timer</h2>
      <div id="timerDisplay">00:00:00</div>
      <button id="timerStart">Start</button>
      <button id="timerPause">Pause</button>
      <button id="timerReset">Reset</button>
    </div>

    <div class="box">
      <h2>Stopwatch</h2>
      <div id="stopwatchDisplay">00:00:00</div>
      <button id="stopwatchStart">Start</button>
      <button id="stopwatchPause">Pause</button>
      <button id="stopwatchReset">Reset</button>
    </div>

    <div class="box">
      <h2>Projects</h2>
      <input type="text" id="projectName" placeholder="Enter project name" />
      <button onclick="addProject()">Add Project</button>
      <div id="projectList"></div>
    </div>
  </div>

  <div class="box">
    <h2>Daily Summary (<span id="todayLabel"></span>)</h2>
    <p>Total Minutes: <span id="totalMinutes">0</span> / Target: <span id="dailyTarget">240</span></p>
    <table>
      <thead>
        <tr><th>Project</th><th>Minutes</th><th>Actions</th></tr>
      </thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </div>

  <script>
    const projectData = JSON.parse(localStorage.getItem("projects") || "{}");
    const selectedDate = new Date().toISOString().slice(0, 10);
    const summaryBody = document.getElementById("summaryBody");
    const totalMinutesEl = document.getElementById("totalMinutes");
    const todayLabel = document.getElementById("todayLabel");
    todayLabel.textContent = selectedDate;

    let timerSec = 0, stopwatchSec = 0;
    let timerInt = null, stopwatchInt = null;
    let currentProject = null;

    function pad(n) { return n.toString().padStart(2, '0'); }
    function formatTime(s) {
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${pad(h)}:${pad(m)}:${pad(sec)}`;
    }

    function updateDisplays() {
      document.getElementById("timerDisplay").textContent = formatTime(timerSec);
      document.getElementById("stopwatchDisplay").textContent = formatTime(stopwatchSec);
    }

    function saveData() {
      localStorage.setItem("projects", JSON.stringify(projectData));
    }

    function updateSummary() {
      summaryBody.innerHTML = "";
      let total = 0;
      Object.entries(projectData).forEach(([name, rec]) => {
        const min = rec[selectedDate] || 0;
        total += min;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${name}</td>
          <td>${min}</td>
          <td>
            <div class="manual-input">
              <input type="number" id="add-${name}" placeholder="+/-">
              <button onclick="modifyMinutes('${name}', 'add')">Add</button>
              <button onclick="modifyMinutes('${name}', 'subtract')">Subtract</button>
              <button onclick="deleteProject('${name}')">Delete</button>
            </div>
          </td>
        `;
        summaryBody.appendChild(tr);
      });
      totalMinutesEl.textContent = total;
    }

    function addProject() {
      const name = document.getElementById("projectName").value.trim();
      if (!name || projectData[name]) return alert("Invalid or duplicate project");
      projectData[name] = {};
      currentProject = name;
      document.getElementById("projectName").value = "";
      updateSummary();
      saveData();
    }

    function deleteProject(name) {
      if (confirm(`Delete project "${name}"?`)) {
        delete projectData[name];
        if (currentProject === name) currentProject = null;
        updateSummary();
        saveData();
      }
    }

    function modifyMinutes(name, type) {
      const input = document.getElementById(`add-${name}`);
      const val = parseInt(input.value);
      if (isNaN(val)) return alert("Enter a number");
      if (!projectData[name][selectedDate]) projectData[name][selectedDate] = 0;
      if (type === "add") projectData[name][selectedDate] += val;
      else projectData[name][selectedDate] = Math.max(0, projectData[name][selectedDate] - val);
      input.value = "";
      updateSummary();
      saveData();
    }

    function tick(type) {
      if (!currentProject) return;
      if (!projectData[currentProject][selectedDate]) projectData[currentProject][selectedDate] = 0;
      if (type === 'timer') timerSec += 1;
      if (type === 'stopwatch') stopwatchSec += 1;
      projectData[currentProject][selectedDate] += 1 / 60;
      updateDisplays();
      updateSummary();
      saveData();
    }

  // --- New Statistics Tables ---

  // Utility: get current month
  function getCurrentMonth() {
    const now = new Date();
    return now.toISOString().slice(0, 7); // "YYYY-MM"
  }

  // Utility: get week number of year
  function getWeekNumber(d) {
    d = new Date(d);
    d.setHours(0, 0, 0, 0);
    d.setDate(d.getDate() + 4 - (d.getDay() || 7));
    const yearStart = new Date(d.getFullYear(), 0, 1);
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }

  // 1. Top 5 Monthly Projects
  function renderTopMonthlyProjects() {
    const month = getCurrentMonth();
    const totals = {};
    for (const [name, records] of Object.entries(projectData)) {
      for (const [date, minutes] of Object.entries(records)) {
        if (date.startsWith(month)) {
          totals[name] = (totals[name] || 0) + minutes;
        }
      }
    }

    const sorted = Object.entries(totals).sort((a, b) => b[1] - a[1]).slice(0, 5);
    let html = `<h2>Top 5 Projects - ${month}</h2><table><thead><tr><th>Project</th><th>Minutes</th></tr></thead><tbody>`;
    for (const [name, min] of sorted) {
      html += `<tr><td>${name}</td><td>${Math.round(min)}</td></tr>`;
    }
    html += '</tbody></table>';

    const box = document.createElement('div');
    box.className = 'box';
    box.innerHTML = html;
    document.body.appendChild(box);
  }

  // 2. Weekday-wise Average (Monâ€“Fri)
  function renderWeekdayAverages() {
    const weekdayTotals = { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0 };
    const counts = { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0 };

    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    for (const records of Object.values(projectData)) {
      for (const [date, minutes] of Object.entries(records)) {
        const d = new Date(date);
        const weekday = days[d.getDay()];
        if (weekday in weekdayTotals) {
          weekdayTotals[weekday] += minutes;
          counts[weekday]++;
        }
      }
    }

    let html = `<h2>Weekday Averages</h2><table><thead><tr><th>Weekday</th><th>Avg. Minutes</th></tr></thead><tbody>`;
    for (const day of ['Mon', 'Tue', 'Wed', 'Thu', 'Fri']) {
      const avg = counts[day] ? (weekdayTotals[day] / counts[day]) : 0;
      html += `<tr><td>${day}</td><td>${Math.round(avg)}</td></tr>`;
    }
    html += '</tbody></table>';

    const box = document.createElement('div');
    box.className = 'box';
    box.innerHTML = html;
    document.body.appendChild(box);
  }

  // 3. Weekly Stats
  function renderWeeklyStats() {
    const weekData = {};
    for (const [_, records] of Object.entries(projectData)) {
      for (const [date, minutes] of Object.entries(records)) {
        const week = getWeekNumber(date);
        weekData[week] = (weekData[week] || 0) + minutes;
      }
    }

    const sortedWeeks = Object.keys(weekData).sort((a, b) => a - b).slice(-4); // last 4 weeks
    let html = `<h2>Weekly Stats</h2><table><thead><tr><th>Week #</th><th>Total Minutes</th></tr></thead><tbody>`;
    for (const week of sortedWeeks) {
      html += `<tr><td>Week ${week}</td><td>${Math.round(weekData[week])}</td></tr>`;
    }
    html += '</tbody></table>';

    const box = document.createElement('div');
    box.className = 'box';
    box.innerHTML = html;
    document.body.appendChild(box);
  }

    // Render all stats
    renderTopMonthlyProjects();
    renderWeekdayAverages();
    renderWeeklyStats();
      
    function getTargetForDate(dateStr) {
  const day = new Date(dateStr).getDay(); // 0=Sun, 1=Mon...
  if (day >= 1 && day <= 4) return 240;
  if (day === 5) return 180;
  return 0; // Sat, Sun
}

function renderAllTimeAverage() {
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const dailyTotals = {};

  // Aggregate minutes per date
  for (const records of Object.values(projectData)) {
    for (const [date, minutes] of Object.entries(records)) {
      dailyTotals[date] = (dailyTotals[date] || 0) + minutes;
    }
  }

  const datesSorted = Object.keys(dailyTotals).sort();

  let html = `<h2>ðŸ“… All-Time Daily Progress</h2><table><thead>
    <tr><th>Date</th><th>Day</th><th>Minutes</th><th>Target</th><th>%</th></tr>
    </thead><tbody>`;

  for (const date of datesSorted) {
    const minutes = Math.round(dailyTotals[date]);
    const day = dayNames[new Date(date).getDay()];
    const target = getTargetForDate(date);
    const percent = target ? Math.round((minutes / target) * 100) : 0;
    html += `<tr><td>${date}</td><td>${day}</td><td>${minutes}</td><td>${target}</td><td>${percent}%</td></tr>`;
  }

  html += '</tbody></table>';

  const box = document.createElement('div');
  box.className = 'box';
  box.innerHTML = html;
  document.body.appendChild(box);
}

renderAllTimeAverage();
    // Timer
    document.getElementById("timerStart").onclick = () => {
      if (!timerInt) timerInt = setInterval(() => tick('timer'), 1000);
    };
    document.getElementById("timerPause").onclick = () => {
      clearInterval(timerInt); timerInt = null;
    };
    document.getElementById("timerReset").onclick = () => {
      clearInterval(timerInt); timerInt = null; timerSec = 0; updateDisplays();
    };

    // Stopwatch
    document.getElementById("stopwatchStart").onclick = () => {
      if (!stopwatchInt) stopwatchInt = setInterval(() => tick('stopwatch'), 1000);
    };
    document.getElementById("stopwatchPause").onclick = () => {
      clearInterval(stopwatchInt); stopwatchInt = null;
    };
    document.getElementById("stopwatchReset").onclick = () => {
      clearInterval(stopwatchInt); stopwatchInt = null; stopwatchSec = 0; updateDisplays();
    };

    updateDisplays();
    updateSummary();
  </script>

</body>
</html>
